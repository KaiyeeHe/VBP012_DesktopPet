<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ğŸ† é‡‘é’±è±¹</title>
    <style>
        /* === å…¨å±€ç¯å¢ƒ === */
        body {
            /* å®Œå…¨é€æ˜èƒŒæ™¯ */
            background-color: transparent;
            margin: 0;
            overflow: hidden;
            font-family: "Menlo", "Monaco", -apple-system, monospace;
            user-select: none;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: default; /* Default cursor */
            pointer-events: none; /* Allow clicks to pass through by default */
        }

        #main-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none; /* é»˜è®¤ç©¿é€ */
        }

        /* === æ°”æ³¡æç¤º === */
        .bubble-container {
            height: 60px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            margin-bottom: 5px;
            z-index: 200;
            pointer-events: auto; /* æ°”æ³¡å¯äº¤äº’ */
        }

        .bubble {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #000;
            padding: 10px 18px; /* ç¨å¾®åŠ å¤§ä¸€ç‚¹å†…è¾¹è· */
            border-radius: 16px;
            width: max-content;
            max-width: 200px;
            display: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            animation: pop-in 0.3s;
        }
        
        .bubble::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            border-width: 8px 8px 0; border-style: solid; border-color: #000 transparent transparent transparent;
        }
        .bubble h3 { margin: 0; font-size: 14px; color: #000; font-weight: 800; line-height: 1.4; }
        .bubble p { margin: 4px 0 0 0; font-size: 12px; color: #333; font-weight: bold; }
        .urgent-mode .bubble { border-color: #d35400; animation: shake-tiny 0.2s infinite; }

        /* === è§†è§‰åŒºåŸŸ === */
        #pet-visual-area {
            width: 200px;
            height: 160px;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto; 
            position: relative;
        }

        .leopard-visual {
            font-size: 100px; 
            filter: drop-shadow(0px 8px 10px rgba(0,0,0,0.15)); 
            user-select: none;
            -webkit-user-drag: none;
            pointer-events: none;
            animation: idle-bounce 2.5s infinite ease-in-out; 
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
            transform-origin: bottom center;
        }

        /* === ğŸ’ çº¯ç™½ä¸é€æ˜çŠ¶æ€æ  === */
        #status-bar {
            background: #ffffff;
            border: 2px solid #000000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border-radius: 16px 0 16px 16px; /* å³ä¸Šè§’æ— åœ†è§’ */
            padding: 10px 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0px; /* å»æ‰gapï¼Œç”¨paddingæ§åˆ¶ */

            margin-top: 10px;
            pointer-events: auto;
            z-index: 150;
            min-width: 130px;
            position: relative; /* ä¸ºå³ä¸Šè§’æŒ‰é’®å®šä½ */
        }

        /* å³ä¸Šè§’æŒ‰é’®ç»„ - æ——å¸œæ ·å¼ */
        .corner-buttons {
            position: absolute;
            top: -2px; /* ä¸çŠ¶æ€æ é¡¶éƒ¨è¾¹æ¡†å¯¹é½ */
            right: -30px; /* ç¨å¾®è°ƒæ•´ä½ç½® */
            display: flex;
            flex-direction: column;
            gap: 0;
            z-index: 200;
        }

        .corner-btn {
            width: 30px;
            height: 28px;
            background: #fff;
            border: 2px solid #000;
            border-left: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            color: #000;
            padding: 0;
            transition: all 0.2s ease;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
            pointer-events: auto; /* ç¡®ä¿æŒ‰é’®å¯ç‚¹å‡» */
            position: relative;
            z-index: 250; /* æé«˜å±‚çº§ç¡®ä¿åœ¨æœ€ä¸Šé¢ */
        }

        .corner-btn:first-child {
            border-radius: 0 8px 0 0;
            border-top: 2px solid #000;
        }

        .corner-btn:not(:first-child):not(:last-child) {
            margin-top: -2px; /* ä¸­é—´æŒ‰é’®ä¸Šç§»è®©è¾¹æ¡†é‡å  */
        }

        .corner-btn:last-child {
            border-radius: 0 0 8px 0;
            margin-top: -2px; /* ä¸Šç§»2pxè®©è¾¹æ¡†é‡å  */
        }

        .corner-btn:hover {
            background: #f5f5f5;
            transform: translateX(2px);
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.2);
        }

        .corner-btn:active {
            transform: translateX(0);
        }

        /* âš¡ï¸ ç¬¬ä¸€è¡Œï¼šé«˜åº¦é”å®š */
        .status-row-top {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            height: 32px; /* é”å®šé«˜åº¦ä¸æŒ‰é’®ä¸€è‡´ */
            border-bottom: 1px dashed rgba(0,0,0,0.2); 
            margin-bottom: 8px; /* ä¸Šä¸‹é—´è· */
        }

        /* âš¡ï¸ ç¬¬äºŒè¡Œï¼šé«˜åº¦é”å®š */
        .controls {
            display: flex;
            gap: 14px;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 32px; /* é”å®šé«˜åº¦ */
        }

        .status-text {
            font-size: 15px; 
            font-weight: 800;
            color: #000; 
            line-height: 1;
            padding-top: 2px;
        }
        .status-text.resting { color: #d35400; }
        .divider { width: 2px; height: 16px; background-color: #000; } 

        /* === çº¯è‰²æŒ‰é’® (ä¸é€æ˜) === */
        .mini-btn {
            width: 30px; height: 30px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-radius: 8px;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            font-size: 15px; color: #222; padding: 0;
            transition: all 0.2s ease;
        }

        .mini-btn:hover {
            background: #e8e8e8;
            border-color: #ccc;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .mini-btn:active { transform: translateY(1px); background: #ddd; }

        /* === è¾…åŠ©å…ƒç´  === */
        #countdown-display { font-size: 32px; font-weight: 900; color: #000; display: none; margin: 4px 0; }
        #finish-btn {
            background: #000; color: #fff; border: 2px solid #000; padding: 8px 24px; border-radius: 30px;
            cursor: pointer; font-weight: 900; display: none; margin: 5px auto 0; font-size: 15px;
            pointer-events: auto; transition: transform 0.1s; box-shadow: 0 4px #555;
        }
        #finish-btn:active { transform: translateY(4px); box-shadow: 0 0 #555; }

        /* === ğŸš ä¼˜åŒ–ï¼šé«˜é¢‘æ‘‡æ‘†èµ·é£ (High Freq Wiggle) === */
        .anim-takeoff { animation: takeoff-wiggle 2s ease-in-out forwards !important; }
        
        @keyframes takeoff-wiggle {
            0% { transform: translateY(0) scale(1, 1) rotate(0deg); }
            10% { transform: translateY(10px) scale(1.2, 0.8) rotate(0deg); } 
            
            /* âš¡ï¸ å¿«é€Ÿå·¦å³æ‘‡æ‘† */
            20% { transform: translateY(-60px) rotate(-20deg); }
            30% { transform: translateY(-100px) rotate(20deg); }
            40% { transform: translateY(-130px) rotate(-20deg); }
            50% { transform: translateY(-140px) rotate(20deg); }
            60% { transform: translateY(-130px) rotate(-20deg); }
            70% { transform: translateY(-100px) rotate(10deg); }
            
            80% { transform: translateY(0) scale(1, 1) rotate(0deg); } 
            90% { transform: translateY(5px) scale(1.1, 0.9) rotate(0deg); } 
            100% { transform: translateY(0) scale(1, 1) rotate(0deg); }
        }

        /* === ğŸ’ƒ å¿«ä¹æ‘‡æ‘† === */
        .anim-wiggle { animation: wiggle-happy 1s ease-in-out forwards !important; }
        @keyframes wiggle-happy {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            50% { transform: rotate(15deg); }
            75% { transform: rotate(-15deg); }
        }

        /* ç‰¹æ•ˆç±» */
        .anim-rub { animation: rub-head 0.4s infinite alternate !important; }
        @keyframes rub-head { 0% { transform: scale(1.1) rotate(-5deg); } 100% { transform: scale(1.1) rotate(5deg); } }
        .heart-emoji { position: absolute; font-size: 24px; pointer-events: none; z-index: 999; animation: float-heart 1s forwards ease-out; }
        @keyframes float-heart { 0% { opacity: 1; transform: translateY(0) scale(0.5); } 100% { opacity: 0; transform: translateY(-60px) scale(1.2); } }
        .reward-emoji { position: absolute; font-size: 40px; pointer-events: none; z-index: 999; left: 50%; top: 50%; animation: explode 1.2s forwards cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes explode { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(1.5); opacity: 0; } }
        
        @keyframes pop-in { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes idle-bounce { 0%, 100% { transform: scale(1, 1) translateY(0); } 50% { transform: scale(1.05, 0.96) translateY(6px); } }
        @keyframes shake-tiny { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-2deg); } 75% { transform: rotate(2deg); } }
        
        .anim-fly-away { animation: fly-away 1.5s forwards ease-in !important; }
        @keyframes fly-away { 0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 1; } 100% { transform: translate(150px, -300px) rotate(120deg) scale(0); opacity: 0; } }
        .anim-spin { animation: spin 2s infinite linear !important; }
        @keyframes spin { 0% { transform: rotate(0deg); } 25% { transform: rotate(-15deg); } 75% { transform: rotate(15deg); } 100% { transform: rotate(0deg); } }
        .anim-shake { animation: shake 1s infinite ease-in-out !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px) rotate(-5deg); } 75% { transform: translateX(10px) rotate(5deg); } }
        .anim-bounce { animation: bounce 0.8s infinite ease-in-out !important; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .anim-stretch { animation: stretch 1.5s infinite ease-in-out !important; }
        @keyframes stretch { 0%, 100% { transform: scale(1, 1); } 50% { transform: scale(0.9, 1.1) translateY(-10px); } }
        .effect-text { position: absolute; font-weight: 900; top: 50%; left: 50%; transform: translateX(-50%); z-index: 300; width: 200px; text-align: center; font-size: 18px; color: #000; text-shadow: 2px 2px 0 #fff; }
        @keyframes float-up { 0% { opacity: 1; margin-top: 0; } 100% { opacity: 0; margin-top: -80px; } }

        /* === è‡ªå®šä¹‰ç¡®è®¤å¼¹çª— === */
        #custom-confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            pointer-events: auto;
        }

        #custom-confirm-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #custom-confirm-box {
            background: #fff;
            border: 3px solid #000;
            border-radius: 20px;
            padding: 25px 20px;
            width: 240px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            animation: modal-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes modal-pop {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        #custom-confirm-icon {
            font-size: 80px;
            margin-bottom: 15px;
            animation: leopard-wiggle 0.6s ease-in-out infinite;
        }

        @keyframes leopard-wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-12deg); }
            75% { transform: rotate(12deg); }
        }

        #custom-confirm-message {
            font-size: 16px;
            font-weight: 800;
            color: #000;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .confirm-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-btn {
            flex: 1;
            padding: 8px 14px;
            border: 2px solid #000;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
        }

        .confirm-btn.yes {
            background: #000;
            color: #fff;
        }

        .confirm-btn.yes:hover {
            background: #333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .confirm-btn.no {
            background: #f5f5f5;
            color: #000;
        }

        .confirm-btn.no:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .confirm-btn:active {
            transform: translateY(0);
        }

        /* === é€šç”¨æ¨¡æ€æ¡†æ ·å¼ === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10000;
            pointer-events: auto;
        }

        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: #fff;
            border: 3px solid #000;
            border-radius: 20px;
            padding: 20px;
            width: 280px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modal-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-box.large {
            width: 400px;
            max-height: 500px;
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-icon {
            font-size: 28px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 900;
            color: #000;
            margin: 0;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-body.scrollable {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-item label {
            display: block;
            font-size: 14px;
            font-weight: 800;
            color: #000;
            margin-bottom: 8px;
        }

        .setting-item input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .setting-item input:focus {
            outline: none;
            border-color: #000;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            flex: 1;
            padding: 10px 16px;
            border: 2px solid #000;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.save {
            background: #000;
            color: #fff;
        }

        .modal-btn.save:hover {
            background: #333;
            transform: translateY(-2px);
        }

        .modal-btn.cancel {
            background: #f5f5f5;
            color: #000;
        }

        .modal-btn.cancel:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        /* æ•°æ®è®°å½•æ ·å¼ */
        .data-day {
            margin-bottom: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            padding: 15px;
        }

        .data-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .data-day-date {
            font-size: 16px;
            font-weight: 900;
            color: #000;
        }

        .data-day-stats {
            font-size: 14px;
            font-weight: 700;
            color: #666;
        }

        .data-session {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin: 5px 0;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .data-session-time {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            min-width: 70px;
        }

        .data-session-activity {
            flex: 1;
            font-size: 14px;
            font-weight: 700;
            color: #000;
        }

        .data-session-status {
            font-size: 18px;
        }

        .data-empty {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 14px;
        }
</style>
</head>
<body>
    <div id="main-wrapper">
        <div class="bubble-container">
            <div class="bubble" id="banner">
                <h3 id="action-title">å‡†å¤‡</h3>
                <p id="action-desc">...</p>
                <div id="countdown-display">10</div>
                <button id="finish-btn">ğŸ’° æ‰“å¡è¿›é’±ğŸ’°</button>
            </div>
        </div>

        <div id="pet-visual-area">
            <div class="leopard-visual" id="leopard">ğŸ†</div>
        </div>

        <!-- ğŸ’ é»‘è¾¹çŠ¶æ€æ  -->
        <div id="status-bar">
            <!-- å³ä¸Šè§’æŒ‰é’® -->
            <div class="corner-buttons">
                <button class="corner-btn" id="btn-settings" title="è®¾ç½®">âš™ï¸</button>
                <button class="corner-btn" id="btn-data" title="æ•°æ®">ğŸ“Š</button>
                <button class="corner-btn" id="btn-quit" title="é€€å‡ºåº”ç”¨ (âŒ˜Q)">âœ•</button>
            </div>

            <!-- ç¬¬ä¸€è¡Œï¼šæ•°æ® -->
            <div class="status-row-top">
                <span id="work-timer" class="status-text">â³ 10:00</span>
                <div class="divider"></div>
                <span class="status-text">ä»Šæ—¥ Â¥<span id="money-count">0</span></span>
            </div>
            <!-- ç¬¬äºŒè¡Œï¼šæŒ‰é’® -->
            <div class="controls">
                <button class="mini-btn" id="btn-speak" title="è¯´å¥è¯">ğŸ’¬</button>
                <button class="mini-btn" id="btn-pause" title="æš‚åœ/ç»§ç»­">âšâš</button>
                <button class="mini-btn" id="btn-restart" title="é‡æ–°å¼€å§‹">â†»</button>
                <button class="mini-btn" id="btn-confirm-checkin" title="ç¡®è®¤æ‰“å¡">âœ…</button>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰ç¡®è®¤å¼¹çª— -->
    <div id="custom-confirm-modal">
        <div id="custom-confirm-backdrop">
            <div id="custom-confirm-box">
                <div id="custom-confirm-icon">ğŸ†</div>
                <div id="custom-confirm-message">ç¡®å®šä¸Šä¸€è½®å·²ç»æ”¾æ¾äº†å˜›ï¼</div>
                <div class="confirm-buttons">
                    <button class="confirm-btn no" id="confirm-no">å–æ¶ˆ</button>
                    <button class="confirm-btn yes" id="confirm-yes">ç¡®è®¤æ‰“å¡ğŸ’°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settings-modal" class="modal">
        <div class="modal-backdrop">
            <div class="modal-box">
                <div class="modal-header">
                    <span class="modal-icon">âš™ï¸</span>
                    <h3 class="modal-title">è®¾ç½®</h3>
                </div>
                <div class="modal-body">
                    <div class="setting-item">
                        <label>å·¥ä½œæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰</label>
                        <input type="number" id="input-work-time" min="1" max="120" value="10">
                    </div>
                    <div class="setting-item">
                        <label>ä¼‘æ¯æ—¶é—´ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="input-rest-time" min="10" max="300" value="30">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" id="settings-cancel">å–æ¶ˆ</button>
                    <button class="modal-btn save" id="settings-save">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ•°æ®å±•ç¤ºå¼¹çª— -->
    <div id="data-modal" class="modal">
        <div class="modal-backdrop">
            <div class="modal-box large">
                <div class="modal-header">
                    <span class="modal-icon">ğŸ“Š</span>
                    <h3 class="modal-title">æ‰“å¡è®°å½•</h3>
                </div>
                <div class="modal-body scrollable" id="data-content">
                    <!-- åŠ¨æ€ç”Ÿæˆæ•°æ®å†…å®¹ -->
                </div>
                <div class="modal-footer">
                    <button class="modal-btn cancel" id="data-close">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ipcRenderer = null;
        try { if (window.require) { ipcRenderer = window.require('electron').ipcRenderer; } } catch (e) {}

        // ä»localStorageè¯»å–è®¾ç½®
        function loadSettings() {
            const saved = localStorage.getItem('petSettings');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        // ä¿å­˜è®¾ç½®åˆ°localStorage
        function saveSettings(settings) {
            localStorage.setItem('petSettings', JSON.stringify(settings));
        }

        // === æ•°æ®è®°å½•ç®¡ç† ===
        function loadHistory() {
            const saved = localStorage.getItem('petHistory');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    return [];
                }
            }
            return [];
        }

        function saveHistory(history) {
            localStorage.setItem('petHistory', JSON.stringify(history));
        }

        function recordSession(checkedIn, activity) {
            const history = loadHistory();
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
            const timeStr = now.toTimeString().split(' ')[0]; // HH:MM:SS

            // æŸ¥æ‰¾ä»Šå¤©çš„è®°å½•
            let todayRecord = history.find(day => day.date === dateStr);
            if (!todayRecord) {
                todayRecord = { date: dateStr, sessions: [] };
                history.push(todayRecord);
            }

            // æ·»åŠ æœ¬æ¬¡è®°å½•
            todayRecord.sessions.push({
                time: timeStr,
                checkedIn: checkedIn,
                activity: activity
            });

            saveHistory(history);
        }

        // åˆå§‹åŒ–CONFIGï¼Œä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„è®¾ç½®
        const savedSettings = loadSettings();
        const CONFIG = {
            WORK_TIME_SECONDS: savedSettings?.workTimeMinutes ? savedSettings.workTimeMinutes * 60 : 10 * 60,
            EXERCISE_TOTAL_SECONDS: savedSettings?.restTimeSeconds || 30,
            URGENT_SECONDS: 10,
            ROTATE_INTERVAL_MS: 5 * 60 * 1000,
            POPUP_INTERVAL_MS: 3 * 60 * 1000
        };

        const randomPopups = ["è¿˜æ´»ç€ï¼", "åœ¨å‘¼å¸ï¼", "æƒ³è¦å¤§House", "å½“ç‰›åšé©¬ä¸­ï¼", "è´¢ä»å››é¢å…«æ–¹æ¥ï¼", "å¸¦è–ªæ‘¸é±¼"];
        const urgentTexts = [
            "æ•‘æ•‘ï¼æ•‘æ•‘è„–å­ï¼ğŸ˜±",
            "é’±è¦é£èµ°å•¦ï¼ğŸ’¸",
            "åˆ«åšç¡¬é‚¦é‚¦çš„çŸ³å¤´ï¼ğŸ—¿",
            "å¿«åŠ¨åŠ¨ï¼è¦ç”Ÿé”ˆäº†ï¼ğŸ¤–",
            "é¢ˆæ¤åœ¨å°–å«å•Šï¼ğŸ“¢",
            "ä¸æƒ³å˜æˆé©¼èƒŒè±¹ï¼ğŸ†",
            "åŠ¨èµ·æ¥ï¼é’±åœ¨ç­‰ä½ ï¼ğŸ’°",
            "å¥åº·å€¼ -1 -1 -1 ğŸ“‰"];
        const clickEmojis = ["ğŸ˜»", "ğŸ˜½", "ğŸ˜º", "ğŸ˜¸"]; 
        
        const celebrateAnims = ["anim-takeoff", "anim-takeoff", "anim-wiggle"];

        const exerciseLibrary = [
             // ğŸ¦’ é¢ˆéƒ¨/å¤´éƒ¨
            { t: "å¤©é¹…é¢ˆ", d: "ç”¨é¼»å°–åœ¨ç©ºä¸­å†™ä¸€ä¸ª'8'å­—ï¼Œå¯“æ„å‘å‘å‘", icon: "ğŸ¦’", anim: "anim-spin" },
            { t: "æ‹’ç»ç©·ç¥", d: "ç¼“æ…¢å·¦å³è½¬å¤´ï¼Œå¯¹ç©·ç¥åšå®šåœ°è¯´ä¸", icon: "ğŸ™…â€â™‚ï¸", anim: "anim-shake" },
            { t: "ä»°æœ›é‡‘å¸", d: "æŠ¬å¤´çœ‹å¤©èŠ±æ¿ï¼Œæƒ³è±¡ä¸Šé¢æ‰é‡‘å¸", icon: "ğŸ™„", anim: "anim-bounce" },
            { t: "ä¾§è€³å¬é’±", d: "å·¦è€³æ‰¾å·¦è‚©ï¼Œå³è€³æ‰¾å³è‚©ï¼Œå¬å¬é’±çš„å£°éŸ³", icon: "ğŸ‘‚", anim: "anim-shake" },
            { t: "ç¼©å¤´ä¹Œé¾Ÿ", d: "ä¿æŒä¸‹å·´æ°´å¹³å‘åç¼©ï¼ŒæŒ¤å‡ºåŒä¸‹å·´", icon: "ğŸ¢", anim: "anim-breathe" },
            { t: "å¤´é¡¶é¡¶é‡‘", d: "å¤´é¡¶ç”¨åŠ›å‘ä¸Šé¡¶ï¼Œåƒé¡¶ç€ä¸€å é’ç¥¨", icon: "ğŸ†™", anim: "anim-stretch" },
            { t: "å·¦å³å¯»å®", d: "å¤´å‘å·¦è½¬åˆ°åº•ï¼Œå†å‘å³è½¬åˆ°åº•", icon: "ğŸ‘€", anim: "anim-shake" },
            { t: "æ”¾æ¾å¤§è„‘", d: "ç”¨æ‰‹æŒ‡è½»è½»æ•²æ‰“å¤´çš®ï¼Œåƒä¸‹é‡‘å¸é›¨", icon: "ğŸ’†â€â™‚ï¸", anim: "anim-breathe" },

            // ğŸ¦… è‚©èƒŒ/ä¸Šè‚¢
            { t: "è€¸è‚©è—é‡‘", d: "ç”¨åŠ›è€¸è‚©æ‰¾è€³æœµï¼Œå¤¹ä½é‡‘å¸ä¸æ‰ä¸‹æ¥", icon: "ğŸ¤·â€â™‚ï¸", anim: "anim-bounce" },
            { t: "æ‘˜é‡‘è‹¹æœ", d: "å·¦æ‰‹å³æ‰‹è½®æµå‘ä¸Šç”¨åŠ›æŠ“å–ï¼é«˜å¤„æœ‰é’±ï¼", icon: "ğŸ™‹â€â™‚ï¸", anim: "anim-stretch" },
            { t: "æ‰©èƒ¸çº³è´¢", d: "åŒæ‰‹å‘åæ‰“å¼€ï¼Œåƒè¦æŠ±ä½ä¸€åº§é‡‘å±±", icon: "ğŸ¤—", anim: "anim-breathe" },
            { t: "èƒŒéƒ¨æ‹±æ¡¥", d: "åŒæ‰‹æŠ±èƒ¸ï¼ŒèƒŒéƒ¨å‘åæ‹±èµ·ï¼Œæ‹‰ä¼¸è„ŠæŸ±", icon: "ğŸ¦", anim: "anim-breathe" },
            { t: "Wå‹æ‹›è´¢", d: "æ‰‹è‡‚æ‘†æˆWå‹ï¼Œå‘åå¤¹ç´§è‚©èƒ›éª¨", icon: "ğŸ”±", anim: "anim-stretch" },
            { t: "å¤§é¹å±•ç¿…", d: "åŒè‡‚æ°´å¹³ä¼¸ç›´ï¼Œç”»å°åœ†åœˆ", icon: "ğŸ¦…", anim: "anim-spin" },
            { t: "èƒŒåæ¡æ‰‹", d: "åŒæ‰‹åœ¨èƒŒåäº¤æ¡ï¼ŒæŒºèµ·èƒ¸è†›", icon: "ğŸ¤", anim: "anim-stretch" },
            { t: "ç›´è‡‚ä¸‹å‹", d: "åŒè‡‚å‘ä¸‹ä¼¸ç›´ç”¨åŠ›æŒ‰å‹ï¼ŒæŠŠæµ®èºæŒ‰ä¸‹å»", icon: "ğŸ‘‡", anim: "anim-bounce" },

            // ğŸ‘ æ‰‹éƒ¨/æ‰‹è…•
            { t: "æ‹›è´¢çŒ«æ‰‹", d: "æ‰‹è…•ç”¨åŠ›å‘å¤–æ¨ï¼ŒæŠŠå‹åŠ›ç»Ÿç»Ÿæ¨èµ°", icon: "ğŸ‘", anim: "anim-shake" },
            { t: "æ•°é’±æŠ½ç­‹", d: "å¿«é€Ÿæ´»åŠ¨æ¯ä¸€æ ¹æ‰‹æŒ‡ï¼Œæ¨¡æ‹Ÿç‚¹é’æœº", icon: "ğŸ¹", anim: "anim-shake" },
            { t: "ç”©æ‰æ™¦æ°”", d: "åƒåˆšæ´—å®Œæ‰‹ä¸€æ ·ç”¨åŠ›ç”©æ‰‹è…•", icon: "ğŸ‘‹", anim: "anim-shake" },
            { t: "é‡‘åˆšé“æ‹³", d: "ç”¨åŠ›æ¡æ‹³5ç§’ï¼Œå†ç”¨åŠ›å¼ å¼€ç‚¸è£‚", icon: "âœŠ", anim: "anim-breathe" },
            { t: "ç¥ˆç¥·æ¶¨è–ª", d: "åŒæ‰‹åˆåï¼Œäº’ç›¸å¯¹æŠ—ç”¨åŠ›æ¨", icon: "ğŸ™", anim: "anim-breathe" },
            { t: "æ‰‹è…•ç”»åœˆ", d: "æ¡æ‹³ï¼Œæ‰‹è…•é¡ºæ—¶é’ˆç”»åœˆï¼Œåœˆä½è´¢å¯Œ", icon: "ğŸ‘Š", anim: "anim-spin" },
            { t: "å‹æŒ‡æ‹‰ä¼¸", d: "ä¸€åªæ‰‹æŠŠå¦ä¸€åªæ‰‹çš„æ‰‹æŒ‡æ‰‹è…•å‘åæ°", icon: "ğŸ–ï¸", anim: "anim-stretch" },
            { t: "å¼¹æŒ‡ç¥åŠŸ", d: "ç”¨åŠ›å¼¹å‡ºæ¯ä¸€æ ¹æ‰‹æŒ‡ï¼Œå‡»ç¢è´«ç©·", icon: "ğŸ‘Œ", anim: "anim-bounce" },

            // ğŸ’ƒ è…°è…¹/æ ¸å¿ƒ
            { t: "æ¡é’±å¼¯è…°", d: "åç€å‘å‰å¼¯è…°ï¼ŒæŒ‡å°–ç¢°è„šå°–", icon: "ğŸ™‡", anim: "anim-bounce" },
            { t: "è½¬è¿å‘¼å•¦åœˆ", d: "æƒ³è±¡è…°ä¸Šæœ‰ä¸ªå‘¼å•¦åœˆï¼Œæ…¢æ…¢è½¬åŠ¨", icon: "ğŸ¡", anim: "anim-spin" },
            { t: "å·¦å³é€¢æº", d: "ä¿æŒåå§¿ï¼Œä¸ŠåŠèº«å‘å·¦è½¬å†å‘å³è½¬", icon: "ğŸ¥¨", anim: "anim-shake" },
            { t: "ä¾§èº«æ‹¿é’±", d: "ä¸€åªæ‰‹å‘ä¸Šä¸¾ï¼Œèº«ä½“å‘å¦ä¸€ä¾§å¼¯æ›²", icon: "ğŸ‹", anim: "anim-shake" },
            { t: "æ”¶è…¹è—é’±", d: "ç”¨åŠ›æ”¶ç´§è‚šå­ï¼ŒåšæŒ10ç§’ï¼Œåˆ«è®©é’±æ‰å‡ºæ¥", icon: "ğŸ¤", anim: "anim-breathe" },
            { t: "æè†æ’é‡‘", d: "åå§¿æè†ï¼Œç”¨è†ç›–å»ç¢°æ‰‹è‚˜", icon: "ğŸ¦µ", anim: "anim-bounce" },
            { t: "åå§¿ä¼¸å±•", d: "åŒæ‰‹äº¤å‰å‘ä¸Šæ¨ï¼ŒæŠŠè…°æ‹”é•¿", icon: "ğŸ§˜", anim: "anim-stretch" },

            // ğŸ‘ è‡€éƒ¨/é«‹éƒ¨
            { t: "å¤¹ç´§é’±åŒ…", d: "ç”¨åŠ›æ”¶ç´§è‡€éƒ¨è‚Œè‚‰ï¼Œå¤¹ç´§ï¼åˆ«æ¾æ°”ï¼", icon: "ğŸ‘", anim: "anim-breathe" },
            { t: "äºŒéƒè…¿å…‹æ˜Ÿ", d: "è„šè¸æ”¾åœ¨è†ç›–ä¸Šï¼Œèº«ä½“å‰å€¾å‹ä¸€å‹", icon: "4ï¸âƒ£", anim: "anim-stretch" },
            { t: "æ‹æ‰“æ”¾æ¾", d: "ç”¨ç©ºå¿ƒæ‹³è½»è½»æ‹æ‰“è‡€éƒ¨ä¾§é¢", icon: "ğŸ‘‹", anim: "anim-shake" },
            { t: "å•è…¿æŠ¬èµ·", d: "åç€æŠŠä¸€æ¡è…¿ä¼¸ç›´æŠ¬èµ·ï¼Œæ„Ÿå—å¤§è…¿å‘åŠ›", icon: "ğŸ“", anim: "anim-stretch" },
            { t: "é«‹éƒ¨ç”»åœˆ", d: "ç«™èµ·æ¥ï¼Œç”¨èƒ¯éƒ¨ç”»ä¸€ä¸ªå¤§å¤§çš„åœ†", icon: "â­•", anim: "anim-spin" },
            { t: "åè¸¢è…¿", d: "ç«™ç«‹å‘åè¸¢è…¿ï¼ŒæŠŠéœ‰è¿è¸¢èµ°", icon: "ğŸ", anim: "anim-shake" },

            // ğŸ¦¶ è…¿éƒ¨/è„šéƒ¨
            { t: "æ­¥æ­¥é«˜å‡", d: "åŸåœ°è¸æ­¥ï¼Œè†ç›–æŠ¬é«˜ï¼", icon: "ğŸƒ", anim: "anim-bounce" },
            { t: "å‹¾è„šæé’±", d: "è„šå°–ç”¨åŠ›å‘å›å‹¾ï¼Œæ‹‰ä¼¸å°è…¿", icon: "ğŸ©°", anim: "anim-stretch" },
            { t: "è¸®è„šæœ›è¿œ", d: "è„šè·ŸæŠ¬èµ·ï¼Œè„šå°–ç€åœ°ï¼Œçœ‹çœ‹è¿œå¤„çš„é’±", icon: "ğŸ•´ï¸", anim: "anim-stretch" },
            { t: "è„šè¸ç”»åœˆ", d: "è½¬åŠ¨è„šè¸ï¼Œé¡ºæ—¶é’ˆä¸‰åœˆï¼Œé€†æ—¶é’ˆä¸‰åœˆ", icon: "ğŸ¦¶", anim: "anim-spin" },
            { t: "è„šè¶¾æŠ“åœ°", d: "åƒç”¨è„šè¶¾æŠ“åœ°ä¸Šçš„ç¡¬å¸ä¸€æ ·ç”¨åŠ›", icon: "ğŸ¦…", anim: "anim-breathe" },
            { t: "éšå½¢è·‘æ­¥", d: "åœ¨æ¡Œå­åº•ä¸‹å¿«é€Ÿäº¤æ›¿è·ºè„š", icon: "ğŸ¾", anim: "anim-shake" },
            { t: "å°è…¿æŒ‰æ‘©", d: "ç”¨è„šè·Ÿå»è¹­å¦ä¸€æ¡è…¿çš„å°è…¿è‚š", icon: "ğŸ¦µ", anim: "anim-shake" },

            // ğŸ‘€ çœ¼ç›/é¢éƒ¨
            { t: "è‚¡å¸‚å¤§ç›˜", d: "çœ¼çƒä¸Šä¸‹çœ‹ï¼Œæ¨¡æ‹Ÿçœ‹Kçº¿å›¾èµ°åŠ¿", icon: "ğŸ‘€", anim: "anim-bounce" },
            { t: "å¯»æ‰¾å•†æœº", d: "é¡ºæ—¶é’ˆè½¬åŠ¨çœ¼çƒä¸¤åœˆï¼Œä¸æ”¾è¿‡ä»»ä½•æœºä¼š", icon: "ğŸ§", anim: "anim-spin" },
            { t: "ç¡®è®¤çœ¼ç¥", d: "ç”¨åŠ›é—­çœ¼3ç§’ï¼Œå†ç”¨åŠ›çå¼€", icon: "ğŸ˜Œ", anim: "anim-breathe" },
            { t: "è¿œçœºæœªæ¥", d: "çœ‹å‘çª—å¤–æœ€è¿œçš„åœ°æ–¹ï¼Œæ”¾æ¾ç«çŠ¶è‚Œ", icon: "ğŸ”­", anim: "anim-stretch" },
            { t: "ç‹®å­å¼€å£", d: "å¼ å¤§å˜´å·´ä¼¸å‡ºèˆŒå¤´ï¼Œæ”¾æ¾é¢éƒ¨è‚Œè‚‰", icon: "ğŸ¦", anim: "anim-stretch" },
            { t: "é¼“è…®çº³ç¦", d: "åƒæ²³è±šä¸€æ ·é¼“èµ·è…®å¸®å­ï¼Œæ†‹æ°”5ç§’", icon: "ğŸ¡", anim: "anim-breathe" },
            { t: "çœ‰å¼€çœ¼ç¬‘", d: "æŒ‘åŠ¨çœ‰æ¯›ï¼Œæ´»åŠ¨é¢å¤´", icon: "ğŸ¤¨", anim: "anim-shake" }
        ];

        const state = {
            isWorking: true, isExercising: false, isPaused: false, money: 0, lastRoundCheckedIn: false,
            countdownTimer: null, workTimer: null, rotateTimer: null, popupTimer: null,
            timeRemaining: CONFIG.WORK_TIME_SECONDS
        };

        const elements = {
            wrapper: document.getElementById('main-wrapper'),
            petArea: document.getElementById('pet-visual-area'),
            leopard: document.getElementById('leopard'),
            bubble: document.getElementById('banner'),
            finishBtn: document.getElementById('finish-btn'),
            actionTitle: document.getElementById('action-title'),
            actionDesc: document.getElementById('action-desc'),
            countdownDisplay: document.getElementById('countdown-display'),
            moneyCount: document.getElementById('money-count'),
            workTimerDisplay: document.getElementById('work-timer'),
            btnPause: document.getElementById('btn-pause'),
            btnRestart: document.getElementById('btn-restart'),
            btnSpeak: document.getElementById('btn-speak'),
            btnConfirmCheckin: document.getElementById('btn-confirm-checkin'),
            confirmModal: document.getElementById('custom-confirm-modal'),
            confirmYes: document.getElementById('confirm-yes'),
            confirmNo: document.getElementById('confirm-no'),
            // æ–°å¢å…ƒç´ 
            btnSettings: document.getElementById('btn-settings'),
            btnData: document.getElementById('btn-data'),
            btnQuit: document.getElementById('btn-quit'),
            settingsModal: document.getElementById('settings-modal'),
            dataModal: document.getElementById('data-modal'),
            inputWorkTime: document.getElementById('input-work-time'),
            inputRestTime: document.getElementById('input-rest-time'),
            settingsSave: document.getElementById('settings-save'),
            settingsCancel: document.getElementById('settings-cancel'),
            dataContent: document.getElementById('data-content'),
            dataClose: document.getElementById('data-close')
        };

        function init() {
            updateTimerUI(state.timeRemaining);
            startWorkLoop();
            startAutoRotate();
            startRandomPopup();
            updateCheckinButtonState(); // Call on init
            setTimeout(() => performRandomCelebration(), 800);
        }

        // Helper to update check-in button state
        function updateCheckinButtonState() {
            elements.btnConfirmCheckin.disabled = state.lastRoundCheckedIn;
            elements.btnConfirmCheckin.style.opacity = state.lastRoundCheckedIn ? '0.5' : '1';
            elements.btnConfirmCheckin.style.cursor = state.lastRoundCheckedIn ? 'not-allowed' : 'pointer';
        }

        // ğŸ”¥ åŠ¨æ€æ§åˆ¶çª—å£ç©¿é€
        function setWindowClickThrough(enabled) {
            if (ipcRenderer) {
                ipcRenderer.send('set-click-through', enabled);
            }
        }

        // ğŸ”¥ å®æ—¶æ£€æµ‹é¼ æ ‡ä½ç½®ï¼Œåˆ¤æ–­æ˜¯å¦åœ¨å¯äº¤äº’åŒºåŸŸ
        let lastClickThroughState = true;

        document.addEventListener('mousemove', (e) => {
            // å¦‚æœæ­£åœ¨æ‹–æ‹½æˆ–å¼¹çª—æ‰“å¼€ï¼Œä¸ç©¿é€
            if (isDragging ||
                elements.confirmModal.style.display === 'block' ||
                elements.settingsModal.style.display === 'block' ||
                elements.dataModal.style.display === 'block') {
                if (lastClickThroughState) {
                    setWindowClickThrough(false);
                    lastClickThroughState = false;
                }
                return;
            }

            // è·å–é¼ æ ‡ä½ç½®ä¸‹çš„å…ƒç´ 
            const elementUnderMouse = document.elementFromPoint(e.clientX, e.clientY);

            // æ£€æŸ¥æ˜¯å¦åœ¨å¯äº¤äº’åŒºåŸŸï¼ˆé‡‘é’±è±¹ã€çŠ¶æ€æ ã€æ°”æ³¡ã€å¼¹çª—ã€è§’è½æŒ‰é’®ï¼‰
            const isInteractive = elementUnderMouse && (
                elementUnderMouse.closest('#pet-visual-area') ||
                elementUnderMouse.closest('#status-bar') ||
                elementUnderMouse.closest('.bubble-container') ||
                elementUnderMouse.closest('#custom-confirm-modal') ||
                elementUnderMouse.closest('.modal') ||
                elementUnderMouse.closest('.corner-buttons')
            );

            const shouldClickThrough = !isInteractive;

            // åªåœ¨çŠ¶æ€æ”¹å˜æ—¶å‘é€æ¶ˆæ¯
            if (shouldClickThrough !== lastClickThroughState) {
                setWindowClickThrough(shouldClickThrough);
                lastClickThroughState = shouldClickThrough;
            }
        });

        // ğŸ”¥ åœ¨ç‚¹å‡»å’Œæ‹–æ‹½æ—¶ä¹Ÿè¦ç¡®ä¿çª—å£ä¸ç©¿é€
        document.addEventListener('mousedown', () => {
            setWindowClickThrough(false);
            lastClickThroughState = false;
        });

        // === æ‹–æ‹½ ===
        let isDragging = false;
        let startX, startY;

        // åªåœ¨å® ç‰©åŒºåŸŸå’ŒçŠ¶æ€æ æ”¯æŒæ‹–æ‹½
        [elements.petArea, document.getElementById('status-bar')].forEach(dragArea => {
            dragArea.addEventListener('mousedown', (e) => {
                // Prevent dragging if clicking on interactive elements
                if (e.target.closest('button') || e.target.closest('.mini-btn') || e.target.id === 'finish-btn') {
                    return;
                }
                isDragging = true;
                startX = e.screenX;
                startY = e.screenY;
                setWindowClickThrough(false); // Disable click-through while dragging
            });
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging && ipcRenderer) {
                const dx = e.screenX - startX;
                const dy = e.screenY - startY;
                ipcRenderer.send('window-move', { x: dx, y: dy });
                startX = e.screenX;
                startY = e.screenY;
            }
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                // æ‹–æ‹½ç»“æŸåå»¶è¿Ÿä¸€ä¸‹å†æ ¹æ®é¼ æ ‡ä½ç½®å†³å®šæ˜¯å¦ç©¿é€
                setTimeout(() => {
                    const e = { clientX: 0, clientY: 0 };
                    // è§¦å‘ä¸€æ¬¡mousemoveæ¥æ›´æ–°ç©¿é€çŠ¶æ€
                }, 100);
            }
        });

        // === âš¡ï¸ çº¯å‡€è¯´è¯åŠŸèƒ½ (ä¿®å¤ï¼šå¼ºåˆ¶éšè—å€’è®¡æ—¶) ===
        elements.btnSpeak.addEventListener('click', (e) => {
            e.stopPropagation();
            triggerSpeak();
        });

        // Event listener for the new check-in button
        elements.btnConfirmCheckin.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!state.lastRoundCheckedIn) {
                showCustomConfirm();
            }
        });

        // Custom confirm dialog
        function showCustomConfirm() {
            elements.confirmModal.style.display = 'block';
            setWindowClickThrough(false); // Disable click-through when modal is open
        }

        function hideCustomConfirm() {
            elements.confirmModal.style.display = 'none';
            setWindowClickThrough(true); // Re-enable click-through
        }

        elements.confirmYes.addEventListener('click', () => {
            addMoney(10);
            state.lastRoundCheckedIn = true;

            // è®°å½•æ‰‹åŠ¨è¡¥æ‰“å¡æ•°æ®
            const activity = state.currentExercise ? state.currentExercise.t : 'æ‰‹åŠ¨ç¡®è®¤æ‰“å¡';
            recordSession(true, activity);

            triggerBigEmojiExplosion(); // Show some reward feedback
            showEffect('+ğŸ’° æ‰“å¡æˆåŠŸ!');
            updateCheckinButtonState(); // Update button state after check-in
            hideCustomConfirm();
        });

        elements.confirmNo.addEventListener('click', () => {
            hideCustomConfirm();
        });

        // Close modal when clicking backdrop
        elements.confirmModal.addEventListener('click', (e) => {
            if (e.target === elements.confirmModal || e.target.id === 'custom-confirm-backdrop') {
                hideCustomConfirm();
            }
        });

        // === è®¾ç½®åŠŸèƒ½ ===
        // ç¡®ä¿æŒ‰é’®åŒºåŸŸæ°¸ä¸ç©¿é€
        elements.btnSettings.addEventListener('mouseenter', () => {
            setWindowClickThrough(false);
        });

        elements.btnSettings.addEventListener('click', (e) => {
            e.stopPropagation();
            setWindowClickThrough(false); // å¼ºåˆ¶ç¦ç”¨ç©¿é€
            // æ˜¾ç¤ºå½“å‰è®¾ç½®å€¼
            elements.inputWorkTime.value = Math.floor(CONFIG.WORK_TIME_SECONDS / 60);
            elements.inputRestTime.value = CONFIG.EXERCISE_TOTAL_SECONDS;
            elements.settingsModal.style.display = 'block';
        });

        elements.settingsSave.addEventListener('click', () => {
            const workTimeMinutes = parseInt(elements.inputWorkTime.value);
            const restTimeSeconds = parseInt(elements.inputRestTime.value);

            if (workTimeMinutes > 0 && restTimeSeconds > 0) {
                // ä¿å­˜è®¾ç½®
                saveSettings({
                    workTimeMinutes: workTimeMinutes,
                    restTimeSeconds: restTimeSeconds
                });

                // æ›´æ–°CONFIG
                CONFIG.WORK_TIME_SECONDS = workTimeMinutes * 60;
                CONFIG.EXERCISE_TOTAL_SECONDS = restTimeSeconds;

                // å…³é—­å¼¹çª—
                elements.settingsModal.style.display = 'none';
                setWindowClickThrough(true);

                // æç¤º
                showEffect('âš™ï¸ è®¾ç½®å·²ä¿å­˜');

                // é‡å¯å½“å‰å‘¨æœŸ
                if (confirm('è®¾ç½®å·²ä¿å­˜ï¼æ˜¯å¦ç«‹å³åº”ç”¨æ–°è®¾ç½®ï¼Ÿ\nï¼ˆå°†é‡å¯å½“å‰å·¥ä½œå‘¨æœŸï¼‰')) {
                    if(state.workTimer) clearInterval(state.workTimer);
                    if(state.countdownTimer) clearInterval(state.countdownTimer);
                    state.isPaused = false;
                    elements.btnPause.innerText = "âšâš";
                    state.timeRemaining = CONFIG.WORK_TIME_SECONDS;
                    state.isExercising = false;
                    resetVisuals();
                    startWorkLoop();
                }
            }
        });

        elements.settingsCancel.addEventListener('click', () => {
            elements.settingsModal.style.display = 'none';
            setWindowClickThrough(true);
        });

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        elements.settingsModal.addEventListener('click', (e) => {
            if (e.target === elements.settingsModal || e.target.className === 'modal-backdrop') {
                elements.settingsModal.style.display = 'none';
                setWindowClickThrough(true);
            }
        });

        // === æ•°æ®å±•ç¤ºåŠŸèƒ½ ===
        // ç¡®ä¿æŒ‰é’®åŒºåŸŸæ°¸ä¸ç©¿é€
        elements.btnData.addEventListener('mouseenter', () => {
            setWindowClickThrough(false);
        });

        elements.btnData.addEventListener('click', (e) => {
            e.stopPropagation();
            setWindowClickThrough(false); // å¼ºåˆ¶ç¦ç”¨ç©¿é€
            showDataModal();
        });

        function showDataModal() {
            const history = loadHistory();
            elements.dataContent.innerHTML = '';

            if (history.length === 0) {
                elements.dataContent.innerHTML = '<div class="data-empty">è¿˜æ²¡æœ‰æ‰“å¡è®°å½•å‘¢~<br>å¼€å§‹å·¥ä½œå§ï¼ğŸ’ª</div>';
            } else {
                // å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                const sortedHistory = [...history].reverse();
                sortedHistory.forEach(day => {
                    const checkedInCount = day.sessions.filter(s => s.checkedIn).length;
                    const totalCount = day.sessions.length;
                    const rate = totalCount > 0 ? Math.round((checkedInCount / totalCount) * 100) : 0;

                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'data-day';
                    dayDiv.innerHTML = `
                        <div class="data-day-header">
                            <div class="data-day-date">${formatDate(day.date)}</div>
                            <div class="data-day-stats">${checkedInCount}/${totalCount} (${rate}%)</div>
                        </div>
                        ${day.sessions.map(session => `
                            <div class="data-session">
                                <div class="data-session-time">${session.time.substring(0, 5)}</div>
                                <div class="data-session-activity">${session.activity}</div>
                                <div class="data-session-status">${session.checkedIn ? 'âœ…' : 'âŒ'}</div>
                            </div>
                        `).join('')}
                    `;
                    elements.dataContent.appendChild(dayDiv);
                });
            }

            elements.dataModal.style.display = 'block';
            setWindowClickThrough(false);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            const dateOnly = dateStr.split('T')[0];
            const todayStr = today.toISOString().split('T')[0];
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            if (dateOnly === todayStr) {
                return 'ä»Šå¤©';
            } else if (dateOnly === yesterdayStr) {
                return 'æ˜¨å¤©';
            } else {
                return dateStr;
            }
        }

        elements.dataClose.addEventListener('click', () => {
            elements.dataModal.style.display = 'none';
            setWindowClickThrough(true);
        });

        elements.dataModal.addEventListener('click', (e) => {
            if (e.target === elements.dataModal || e.target.className === 'modal-backdrop') {
                elements.dataModal.style.display = 'none';
                setWindowClickThrough(true);
            }
        });

        // === é€€å‡ºåº”ç”¨åŠŸèƒ½ ===
        elements.btnQuit.addEventListener('mouseenter', () => {
            setWindowClickThrough(false);
        });

        elements.btnQuit.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm('ç¡®å®šè¦é€€å‡ºé‡‘é’±è±¹å—ï¼ŸğŸ’°')) {
                if (ipcRenderer) {
                    ipcRenderer.send('quit-app');
                }
            }
        });

        // å¿«æ·é”®æ”¯æŒ (Command+Q æˆ– Ctrl+Q)
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'q') {
                e.preventDefault();
                if (confirm('ç¡®å®šè¦é€€å‡ºé‡‘é’±è±¹å—ï¼ŸğŸ’°')) {
                    if (ipcRenderer) {
                        ipcRenderer.send('quit-app');
                    }
                }
            }
        });

        function triggerSpeak() {
            const text = randomPopups[Math.floor(Math.random() * randomPopups.length)];
            
            // 1. è®¾ç½®æ–‡å­—
            elements.actionTitle.innerText = text;
            
            // 2. å¼ºåˆ¶éšè—å…¶ä»–å…ƒç´ ï¼Œç¡®ä¿æ°”æ³¡çº¯å‡€
            elements.actionDesc.style.display = 'none';
            elements.countdownDisplay.style.display = 'none';
            elements.finishBtn.style.display = 'none';
            
            // 3. æ˜¾ç¤º
            elements.bubble.style.display = 'block';
            elements.leopard.style.transform = "scale(1.1)";
            setTimeout(() => elements.leopard.style.transform = "scale(1)", 150);

            // 4. 3ç§’åéšè—
            setTimeout(() => {
                // åªæœ‰åœ¨å·¥ä½œæ¨¡å¼ä¸‹æ‰è‡ªåŠ¨éšè—ï¼Œé¿å…æŠŠè¿åŠ¨æ—¶çš„æŒ‡å¯¼ç»™éšè—äº†
                if (state.isWorking) elements.bubble.style.display = 'none';
            }, 3000);
        }

        elements.petArea.addEventListener('click', (e) => {
            if (state.isWorking && !state.isPaused && !state.isExercising) {
                const randomCat = clickEmojis[Math.floor(Math.random() * clickEmojis.length)];
                elements.leopard.innerText = randomCat;
                elements.leopard.classList.add('anim-rub');
                createHeart(e.clientX, e.clientY);
                createHeart(e.clientX + 20, e.clientY - 20);
                setTimeout(() => {
                    elements.leopard.innerText = "ğŸ†";
                    elements.leopard.classList.remove('anim-rub');
                }, 800);
            }
        });

        function createHeart(x, y) {
            const heart = document.createElement('div');
            heart.innerText = "â¤ï¸";
            heart.className = 'heart-emoji';
            heart.style.left = (x - 10) + 'px';
            heart.style.top = (y - 20) + 'px';
            const randomX = (Math.random() - 0.5) * 40;
            heart.style.transform = `translateX(${randomX}px)`;
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 1000);
        }

        // === éšæœºåº†ç¥ ===
        function startAutoRotate() {
            if (state.rotateTimer) clearInterval(state.rotateTimer);
            state.rotateTimer = setInterval(() => {
                if (state.isWorking && !state.isPaused && !state.isExercising) {
                    performRandomCelebration();
                }
            }, CONFIG.ROTATE_INTERVAL_MS);
        }

        function performRandomCelebration() {
            const type = Math.floor(Math.random() * 3);
            // è¿™é‡Œä¸è¯´è¯ï¼Œç›´æ¥åŠ¨ï¼Œæˆ–è€…åªè¯´ç®€å•ä¸€å¥
            triggerSpeak(); 

            if (type === 0) {
                const anim = Math.random() > 0.5 ? 'anim-takeoff' : 'anim-wiggle';
                elements.leopard.classList.add(anim);
                setTimeout(() => elements.leopard.classList.remove(anim), 2000); 
            } else if (type === 1) {
                triggerBigEmojiExplosion(["ğŸ’°", "ğŸ’¸"]);
            } else {
                triggerBigEmojiExplosion(["â¤ï¸", "ğŸ’–", "âœ¨"]);
            }
        }

        // === å¾ªç¯é€»è¾‘ ===
        function startRandomPopup() {
            if (state.popupTimer) clearInterval(state.popupTimer);
            state.popupTimer = setInterval(() => {
                if (state.isWorking && !state.isPaused && !state.isExercising) {
                   triggerSpeak();
                }
            }, CONFIG.POPUP_INTERVAL_MS); 
        }

        function startWorkLoop() {
            state.isWorking = true;
            // ä¸åœ¨è¿™é‡Œé‡ç½®æ‰“å¡çŠ¶æ€ï¼Œè®©å®ƒä¿æŒåˆ°ä¸‹æ¬¡ä¼‘æ¯æ—¶é—´
            updateCheckinButtonState(); // Update button state
            resetVisuals();
            if(state.workTimer) clearInterval(state.workTimer);
            state.workTimer = setInterval(() => {
                if (state.isPaused) return;
                state.timeRemaining--;
                updateTimerUI(state.timeRemaining);
                if (state.timeRemaining <= 0) {
                    clearInterval(state.workTimer);
                    startExercise();
                }
            }, 1000);
        }

        function updateTimerUI(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            if (state.isWorking) {
                elements.workTimerDisplay.innerText = `â³ ${m}:${s}`;
                elements.workTimerDisplay.classList.remove('resting');
            } else {
                elements.workTimerDisplay.innerText = `ğŸ§˜ ${m}:${s}`;
                elements.workTimerDisplay.classList.add('resting');
            }
        }

        function startExercise() {
            state.isWorking = false;
            state.isExercising = true;
            state.timeRemaining = CONFIG.EXERCISE_TOTAL_SECONDS;

            // ğŸ”¥ æ–°ä¸€è½®ä¼‘æ¯å¼€å§‹ï¼Œé‡ç½®æ‰“å¡çŠ¶æ€
            state.lastRoundCheckedIn = false;
            updateCheckinButtonState();

            updateTimerUI(state.timeRemaining);

            if(state.workTimer) clearInterval(state.workTimer);
            state.workTimer = setInterval(() => {
                if (state.isPaused) return;
                state.timeRemaining--;
                updateTimerUI(state.timeRemaining);
            }, 1000);

            const action = exerciseLibrary[Math.floor(Math.random() * exerciseLibrary.length)];
            state.currentExercise = action; // Store current exercise
            elements.actionTitle.innerText = action.t;
            elements.actionDesc.innerText = action.d;
            
            // âš¡ï¸ è¿åŠ¨æ—¶æ˜¾ç¤ºæè¿°
            elements.actionDesc.style.display = 'block';
            elements.countdownDisplay.style.display = 'none';
            elements.finishBtn.style.display = 'none';
            
            elements.leopard.innerText = action.icon;
            elements.leopard.className = "leopard-visual"; 
            void elements.leopard.offsetWidth; 
            elements.leopard.classList.add(action.anim);

            elements.bubble.style.display = 'block';

            const delay = Math.max(0, (CONFIG.EXERCISE_TOTAL_SECONDS - CONFIG.URGENT_SECONDS) * 1000);
            setTimeout(() => { startCountdownSequence(); }, delay);
        }

        function startCountdownSequence() {
            if (!state.isExercising) return;
            const currentTitle = state.currentExercise ? state.currentExercise.t : urgentTexts[0];
            const currentDesc = state.currentExercise ? state.currentExercise.d : "";
            elements.wrapper.classList.add('urgent-mode');
            elements.actionTitle.innerText = currentTitle; // Display exercise title
            elements.actionDesc.innerText = currentDesc; // Display exercise description
            elements.actionDesc.style.display = 'block'; 
            elements.finishBtn.style.display = 'block'; 
            elements.countdownDisplay.style.display = 'block';
            
            let secondsLeft = CONFIG.URGENT_SECONDS;
            elements.countdownDisplay.innerText = secondsLeft;
            
            if(state.countdownTimer) clearInterval(state.countdownTimer);
            state.countdownTimer = setInterval(() => {
                if (state.isPaused) return;
                secondsLeft--;
                elements.countdownDisplay.innerText = secondsLeft;
                if (secondsLeft <= 0) handleTimeout();
            }, 1000);
        }

        function handleTimeout() {
            clearInterval(state.countdownTimer);
            clearInterval(state.workTimer);

            // è®°å½•æ•°æ®ï¼šæœªæ‰“å¡
            const activity = state.currentExercise ? state.currentExercise.t : 'ä¼‘æ¯';
            recordSession(false, activity);

            elements.leopard.innerText = "ğŸ’¸";
            elements.leopard.className = "leopard-visual anim-fly-away";
            elements.actionTitle.innerText = "é£èµ°äº†...";
            elements.finishBtn.style.display = 'none';
            elements.countdownDisplay.style.display = 'none';
            showEffect("æœ¬é’± -1");
            state.lastRoundCheckedIn = false; // Reset for next work round
            updateCheckinButtonState(); // Update button state
            setTimeout(() => {
                state.isExercising = false;
                state.timeRemaining = CONFIG.WORK_TIME_SECONDS;
                startWorkLoop();
            }, 1600);
        }

        elements.finishBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (state.countdownTimer) clearInterval(state.countdownTimer);
            clearInterval(state.workTimer);

            // ç«‹å³éšè—å€’è®¡æ—¶å’ŒæŒ‰é’®
            elements.countdownDisplay.style.display = 'none';
            elements.finishBtn.style.display = 'none';
            elements.wrapper.classList.remove('urgent-mode');

            completeAndReward();
        });

        function completeAndReward() {
            state.isExercising = false;

            // ç«‹å³éšè—æ°”æ³¡å’Œå€’è®¡æ—¶
            elements.bubble.style.display = 'none';
            elements.wrapper.classList.remove('urgent-mode');

            // è®°å½•æ•°æ®ï¼šå·²æ‰“å¡
            const activity = state.currentExercise ? state.currentExercise.t : 'ä¼‘æ¯';
            recordSession(true, activity);

            elements.leopard.innerText = "ğŸ¤‘";
            elements.leopard.className = "leopard-visual";
            elements.leopard.style.animation = "idle-bounce 0.3s infinite";
            addMoney(10);
            triggerBigEmojiExplosion();
            state.lastRoundCheckedIn = true; // æ‰“å¡åè®¾ç½®ä¸ºå·²æ‰“å¡
            updateCheckinButtonState(); // æ›´æ–°æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                state.timeRemaining = CONFIG.WORK_TIME_SECONDS;
                startWorkLoop();
            }, 2000);
        }

        function triggerBigEmojiExplosion(customEmojis) {
            const emojis = customEmojis || ["ğŸ’°", "ğŸ¤‘", "ğŸ’", "ğŸ‰", "ğŸ’¸", "ğŸ§§"];
            for (let i = 0; i < 20; i++) {
                const el = document.createElement('div');
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                el.className = 'reward-emoji';
                const angle = Math.random() * Math.PI * 2;
                const distance = 120 + Math.random() * 150; 
                el.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                el.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 1200);
            }
        }

        function resetVisuals() {
            elements.wrapper.classList.remove('urgent-mode');
            elements.bubble.style.display = 'none';
            elements.leopard.innerText = "ğŸ†";
            elements.leopard.className = "leopard-visual"; 
            elements.leopard.style.animation = "idle-bounce 2.5s infinite ease-in-out"; 
        }

        function addMoney(amount) {
            state.money += amount;
            elements.moneyCount.innerText = state.money;
            showEffect("");
        }

        function showEffect(text) {
            const effect = document.createElement('div');
            effect.className = 'effect-text';
            effect.innerText = text;
            elements.wrapper.appendChild(effect);
            setTimeout(() => effect.remove(), 1500);
        }

        elements.btnPause.addEventListener('click', () => {
            state.isPaused = !state.isPaused;
            elements.btnPause.innerText = state.isPaused ? "â–¶" : "âšâš";
        });
        
        elements.btnRestart.addEventListener('click', () => {
            if(state.workTimer) clearInterval(state.workTimer);
            if(state.countdownTimer) clearInterval(state.countdownTimer);
            state.isPaused = false;
            elements.btnPause.innerText = "âšâš";
            state.timeRemaining = CONFIG.WORK_TIME_SECONDS;
            state.isExercising = false;
            state.lastRoundCheckedIn = false; // Reset for new work round
            updateCheckinButtonState(); // Update button state
            resetVisuals();
            startWorkLoop();
            performRandomCelebration();
        });

        init();
    </script>
</body>
</html>