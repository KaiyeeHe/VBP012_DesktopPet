<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é‡‘é’±è±¹ Stickies ç‰ˆ</title>
    <style>
        /* === å…¨å±€ç¯å¢ƒ === */
        body {
            background-color: transparent;
            margin: 0;
            overflow: hidden;
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            user-select: none;
            /* é€‚é…å°çª—å£å°ºå¯¸ */
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* === ä¸»å®¹å™¨ === */
        #main-wrapper {
            position: relative; /* ä¸å†æ˜¯ absoluteï¼Œå› ä¸ºçª—å£æœ¬èº«åœ¨åŠ¨ */
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            
            /* ğŸ”¥ æ ¸å¿ƒï¼šå¼€å¯åŸç”Ÿçª—å£æ‹–æ‹½ ğŸ”¥ */
            -webkit-app-region: drag;
            cursor: grab;
        }

        /* === è§†è§‰åŒºåŸŸ === */
        #pet-visual-area {
            /* ç¨å¾®ç•™ç‚¹ç©ºé—´ç»™åŠ¨ç”» */
            margin-top: 20px; 
            width: 160px;
            height: 140px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .leopard-visual {
            font-size: 90px;
            filter: drop-shadow(0px 4px 2px rgba(0,0,0,0.2));
            pointer-events: none;
            animation: idle-bounce 2s infinite ease-in-out;
            transition: transform 0.3s;
        }
        
        .facing-left { transform: scaleX(-1); }

        /* === æç®€é»‘ç™½çŠ¶æ€æ  === */
        #status-bar {
            background: #ffffff;
            border: 2px solid #000000;
            border-radius: 20px;
            padding: 4px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 2px 2px 0px rgba(0,0,0,1);
            
            /* å…³é”®ï¼šçŠ¶æ€æ å†…éƒ¨éœ€è¦äº¤äº’ï¼Œæ‰€ä»¥è¦å…³é—­æ‹–æ‹½ */
            -webkit-app-region: no-drag; 
        }

        .status-text { font-size: 13px; font-weight: bold; font-family: monospace; color: #000; }
        .divider { color: #ccc; margin: 0 2px; }

        /* æŒ‰é’®ç»„ */
        .controls { display: flex; gap: 4px; border-left: 1px solid #eee; padding-left: 6px; }
        .mini-btn {
            background: none; border: none; cursor: pointer; font-size: 14px; padding: 0 3px;
            color: #999; transition: all 0.2s;
        }
        .mini-btn:hover { color: #000; }

        /* === æ°”æ³¡æç¤º === */
        .bubble {
            position: absolute;
            top: 0px; /* æ˜¾ç¤ºåœ¨æœ€ä¸Šæ–¹ */
            left: 50%;
            transform: translateX(-50%);
            background: #fff; border: 2px solid #000; padding: 8px;
            border-radius: 12px; width: 160px; display: none;
            box-shadow: 2px 2px 0 #000; text-align: center; z-index: 110;
        }
        .bubble h3 { margin: 0 0 4px 0; font-size: 14px; color: #000; }
        .bubble p { margin: 0; font-size: 12px; color: #333; }

        /* ç´§å¼ æ¨¡å¼ */
        .urgent-mode .bubble { border-bottom: 4px solid #000; }
        #countdown-display { font-size: 24px; font-weight: 900; color: #000; display: none; margin: 2px 0; }
        #finish-btn {
            background: #000; color: #fff; border: none; padding: 4px 12px; border-radius: 12px;
            cursor: pointer; font-weight: bold; display: none; margin: 4px auto 0; font-size: 12px;
            -webkit-app-region: no-drag; /* æŒ‰é’®å¿…é¡»å¯ç‚¹ */
        }

        /* åŠ¨ç”»åº“ */
        @keyframes idle-bounce { 0%, 100% { transform: scale(1, 1) translateY(0); } 50% { transform: scale(1.05, 0.95) translateY(6px); } }
        .anim-fly-away { animation: fly-away 1.5s forwards ease-in !important; }
        @keyframes fly-away { 0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 1; } 100% { transform: translate(150px, -300px) rotate(120deg) scale(0); opacity: 0; } }
        /* å¤ç”¨ä¹‹å‰çš„åŠ¨ç”»... */
        .anim-spin { animation: spin 2s infinite linear !important; }
        @keyframes spin { 0% { transform: rotate(0deg); } 25% { transform: rotate(-15deg); } 75% { transform: rotate(15deg); } 100% { transform: rotate(0deg); } }
        .anim-shake { animation: shake 1s infinite ease-in-out !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px) rotate(-5deg); } 75% { transform: translateX(10px) rotate(5deg); } }
        .anim-bounce { animation: bounce 0.8s infinite ease-in-out !important; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .anim-stretch { animation: stretch 1.5s infinite ease-in-out !important; }
        @keyframes stretch { 0%, 100% { transform: scale(1, 1); } 50% { transform: scale(0.9, 1.1) translateY(-10px); } }
        .effect-text {
            position: absolute; font-weight: 900; top: 10px; left: 50%; transform: translateX(-50%);
            z-index: 300; width: 200px; text-align: center; font-size: 16px; color: #000; text-shadow: 1px 1px 0 #fff;
        }
        @keyframes float-up { 0% { opacity: 1; top: 10px; } 100% { opacity: 0; top: -50px; } }
    </style>
</head>
<body>

    <div id="main-wrapper">
        <!-- æ°”æ³¡ -->
        <div class="bubble" id="banner">
            <h3 id="action-title">å‡†å¤‡</h3>
            <p id="action-desc">...</p>
            <div id="countdown-display">10</div>
            <button id="finish-btn">æ‰“å¡è¿›é’±</button>
        </div>

        <!-- è§†è§‰ -->
        <div id="pet-visual-area">
            <div class="leopard-visual" id="leopard">ğŸ†</div>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div id="status-bar">
            <span id="work-timer" class="status-text">10:00</span>
            <span class="divider">|</span>
            <span class="status-text">Â¥<span id="money-count">0</span></span>
            <div class="controls">
                <!-- å®šä½æŒ‰é’®ï¼šç°åœ¨é€šè¿‡ IPC å‘é€æ¶ˆæ¯ -->
                <button class="mini-btn" id="btn-reset-pos" title="å®šä½å½’ä½">âŒ–</button>
                <button class="mini-btn" id="btn-pause" title="æš‚åœ/ç»§ç»­">âšâš</button>
                <button class="mini-btn" id="btn-restart" title="é‡ç½®">â†»</button>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron'); // ç›´æ¥å¼•å…¥ IPC

        // === é…ç½® ===
        const CONFIG = {
            WORK_TIME_SECONDS: 10 * 60,      
            EXERCISE_TOTAL_SECONDS: 1 * 30,  
            URGENT_SECONDS: 10               
        };

        const exerciseLibrary = [
             // ğŸ¦’ é¢ˆéƒ¨/å¤´éƒ¨
            { t: "å¤©é¹…é¢ˆ", d: "ç”¨é¼»å°–åœ¨ç©ºä¸­å†™ä¸€ä¸ª'8'å­—ï¼Œå¯“æ„å‘å‘å‘", icon: "ğŸ¦’", anim: "anim-spin" },
            { t: "æ‹’ç»ç©·ç¥", d: "ç¼“æ…¢å·¦å³è½¬å¤´ï¼Œå¯¹ç©·ç¥åšå®šåœ°è¯´ä¸", icon: "ğŸ™…â€â™‚ï¸", anim: "anim-shake" },
            { t: "ä»°æœ›é‡‘å¸", d: "æŠ¬å¤´çœ‹å¤©èŠ±æ¿ï¼Œæƒ³è±¡ä¸Šé¢æ‰é‡‘å¸", icon: "ğŸ™„", anim: "anim-bounce" },
            { t: "ä¾§è€³å¬é’±", d: "å·¦è€³æ‰¾å·¦è‚©ï¼Œå³è€³æ‰¾å³è‚©ï¼Œå¬å¬é’±çš„å£°éŸ³", icon: "ğŸ‘‚", anim: "anim-shake" },
            { t: "ç¼©å¤´ä¹Œé¾Ÿ", d: "ä¿æŒä¸‹å·´æ°´å¹³å‘åç¼©ï¼ŒæŒ¤å‡ºåŒä¸‹å·´", icon: "ğŸ¢", anim: "anim-breathe" },
            { t: "å¤´é¡¶é¡¶é‡‘", d: "å¤´é¡¶ç”¨åŠ›å‘ä¸Šé¡¶ï¼Œåƒé¡¶ç€ä¸€å é’ç¥¨", icon: "ğŸ†™", anim: "anim-stretch" },
            { t: "å·¦å³å¯»å®", d: "å¤´å‘å·¦è½¬åˆ°åº•ï¼Œå†å‘å³è½¬åˆ°åº•", icon: "ğŸ‘€", anim: "anim-shake" },
            { t: "æ”¾æ¾å¤§è„‘", d: "ç”¨æ‰‹æŒ‡è½»è½»æ•²æ‰“å¤´çš®ï¼Œåƒä¸‹é‡‘å¸é›¨", icon: "ğŸ’†â€â™‚ï¸", anim: "anim-breathe" },

            // ğŸ¦… è‚©èƒŒ/ä¸Šè‚¢
            { t: "è€¸è‚©è—é‡‘", d: "ç”¨åŠ›è€¸è‚©æ‰¾è€³æœµï¼Œå¤¹ä½é‡‘å¸ä¸æ‰ä¸‹æ¥", icon: "ğŸ¤·â€â™‚ï¸", anim: "anim-bounce" },
            { t: "æ‘˜é‡‘è‹¹æœ", d: "å·¦æ‰‹å³æ‰‹è½®æµå‘ä¸Šç”¨åŠ›æŠ“å–ï¼é«˜å¤„æœ‰é’±ï¼", icon: "ğŸ™‹â€â™‚ï¸", anim: "anim-stretch" },
            { t: "æ‰©èƒ¸çº³è´¢", d: "åŒæ‰‹å‘åæ‰“å¼€ï¼Œåƒè¦æŠ±ä½ä¸€åº§é‡‘å±±", icon: "ğŸ¤—", anim: "anim-breathe" },
            { t: "èƒŒéƒ¨æ‹±æ¡¥", d: "åŒæ‰‹æŠ±èƒ¸ï¼ŒèƒŒéƒ¨å‘åæ‹±èµ·ï¼Œæ‹‰ä¼¸è„ŠæŸ±", icon: "ğŸ¦", anim: "anim-breathe" },
            { t: "Wå‹æ‹›è´¢", d: "æ‰‹è‡‚æ‘†æˆWå‹ï¼Œå‘åå¤¹ç´§è‚©èƒ›éª¨", icon: "ğŸ”±", anim: "anim-stretch" },
            { t: "å¤§é¹å±•ç¿…", d: "åŒè‡‚æ°´å¹³ä¼¸ç›´ï¼Œç”»å°åœ†åœˆ", icon: "ğŸ¦…", anim: "anim-spin" },
            { t: "èƒŒåæ¡æ‰‹", d: "åŒæ‰‹åœ¨èƒŒåäº¤æ¡ï¼ŒæŒºèµ·èƒ¸è†›", icon: "ğŸ¤", anim: "anim-stretch" },
            { t: "ç›´è‡‚ä¸‹å‹", d: "åŒè‡‚å‘ä¸‹ä¼¸ç›´ç”¨åŠ›æŒ‰å‹ï¼ŒæŠŠæµ®èºæŒ‰ä¸‹å»", icon: "ğŸ‘‡", anim: "anim-bounce" },

            // ğŸ‘ æ‰‹éƒ¨/æ‰‹è…•
            { t: "æ‹›è´¢çŒ«æ‰‹", d: "æ‰‹è…•ç”¨åŠ›å‘å¤–æ¨ï¼ŒæŠŠå‹åŠ›ç»Ÿç»Ÿæ¨èµ°", icon: "ğŸ‘", anim: "anim-shake" },
            { t: "æ•°é’±æŠ½ç­‹", d: "å¿«é€Ÿæ´»åŠ¨æ¯ä¸€æ ¹æ‰‹æŒ‡ï¼Œæ¨¡æ‹Ÿç‚¹é’æœº", icon: "ğŸ¹", anim: "anim-shake" },
            { t: "ç”©æ‰æ™¦æ°”", d: "åƒåˆšæ´—å®Œæ‰‹ä¸€æ ·ç”¨åŠ›ç”©æ‰‹è…•", icon: "ğŸ‘‹", anim: "anim-shake" },
            { t: "é‡‘åˆšé“æ‹³", d: "ç”¨åŠ›æ¡æ‹³5ç§’ï¼Œå†ç”¨åŠ›å¼ å¼€ç‚¸è£‚", icon: "âœŠ", anim: "anim-breathe" },
            { t: "ç¥ˆç¥·æ¶¨è–ª", d: "åŒæ‰‹åˆåï¼Œäº’ç›¸å¯¹æŠ—ç”¨åŠ›æ¨", icon: "ğŸ™", anim: "anim-breathe" },
            { t: "æ‰‹è…•ç”»åœˆ", d: "æ¡æ‹³ï¼Œæ‰‹è…•é¡ºæ—¶é’ˆç”»åœˆï¼Œåœˆä½è´¢å¯Œ", icon: "ğŸ‘Š", anim: "anim-spin" },
            { t: "å‹æŒ‡æ‹‰ä¼¸", d: "ä¸€åªæ‰‹æŠŠå¦ä¸€åªæ‰‹çš„æ‰‹æŒ‡æ‰‹è…•å‘åæ°", icon: "ğŸ–ï¸", anim: "anim-stretch" },
            { t: "å¼¹æŒ‡ç¥åŠŸ", d: "ç”¨åŠ›å¼¹å‡ºæ¯ä¸€æ ¹æ‰‹æŒ‡ï¼Œå‡»ç¢è´«ç©·", icon: "ğŸ‘Œ", anim: "anim-bounce" },

            // ğŸ’ƒ è…°è…¹/æ ¸å¿ƒ
            { t: "æ¡é’±å¼¯è…°", d: "åç€å‘å‰å¼¯è…°ï¼ŒæŒ‡å°–ç¢°è„šå°–", icon: "ğŸ™‡", anim: "anim-bounce" },
            { t: "è½¬è¿å‘¼å•¦åœˆ", d: "æƒ³è±¡è…°ä¸Šæœ‰ä¸ªå‘¼å•¦åœˆï¼Œæ…¢æ…¢è½¬åŠ¨", icon: "ğŸ¡", anim: "anim-spin" },
            { t: "å·¦å³é€¢æº", d: "ä¿æŒåå§¿ï¼Œä¸ŠåŠèº«å‘å·¦è½¬å†å‘å³è½¬", icon: "ğŸ¥¨", anim: "anim-shake" },
            { t: "ä¾§èº«æ‹¿é’±", d: "ä¸€åªæ‰‹å‘ä¸Šä¸¾ï¼Œèº«ä½“å‘å¦ä¸€ä¾§å¼¯æ›²", icon: "ğŸ‹", anim: "anim-shake" },
            { t: "æ”¶è…¹è—é’±", d: "ç”¨åŠ›æ”¶ç´§è‚šå­ï¼ŒåšæŒ10ç§’ï¼Œåˆ«è®©é’±æ‰å‡ºæ¥", icon: "ğŸ¤", anim: "anim-breathe" },
            { t: "æè†æ’é‡‘", d: "åå§¿æè†ï¼Œç”¨è†ç›–å»ç¢°æ‰‹è‚˜", icon: "ğŸ¦µ", anim: "anim-bounce" },
            { t: "åå§¿ä¼¸å±•", d: "åŒæ‰‹äº¤å‰å‘ä¸Šæ¨ï¼ŒæŠŠè…°æ‹”é•¿", icon: "ğŸ§˜", anim: "anim-stretch" },

            // ğŸ‘ è‡€éƒ¨/é«‹éƒ¨
            { t: "å¤¹ç´§é’±åŒ…", d: "ç”¨åŠ›æ”¶ç´§è‡€éƒ¨è‚Œè‚‰ï¼Œå¤¹ç´§ï¼åˆ«æ¾æ°”ï¼", icon: "ğŸ‘", anim: "anim-breathe" },
            { t: "äºŒéƒè…¿å…‹æ˜Ÿ", d: "è„šè¸æ”¾åœ¨è†ç›–ä¸Šï¼Œèº«ä½“å‰å€¾å‹ä¸€å‹", icon: "4ï¸âƒ£", anim: "anim-stretch" },
            { t: "åæ‹¥é‡‘å±±", d: "ç¦»å¼€æ¤…å­1å˜ç±³ï¼Œä¿æŒæ·±è¹²å§¿åŠ¿", icon: "ğŸª‘", anim: "anim-bounce" },
            { t: "æ‹æ‰“æ”¾æ¾", d: "ç”¨ç©ºå¿ƒæ‹³è½»è½»æ‹æ‰“è‡€éƒ¨ä¾§é¢", icon: "ğŸ‘‹", anim: "anim-shake" },
            { t: "å•è…¿æŠ¬èµ·", d: "åç€æŠŠä¸€æ¡è…¿ä¼¸ç›´æŠ¬èµ·ï¼Œæ„Ÿå—å¤§è…¿å‘åŠ›", icon: "ğŸ“", anim: "anim-stretch" },
            { t: "é«‹éƒ¨ç”»åœˆ", d: "ç«™èµ·æ¥ï¼Œç”¨èƒ¯éƒ¨ç”»ä¸€ä¸ªå¤§å¤§çš„åœ†", icon: "â­•", anim: "anim-spin" },
            { t: "åè¸¢è…¿", d: "ç«™ç«‹å‘åè¸¢è…¿ï¼ŒæŠŠéœ‰è¿è¸¢èµ°", icon: "ğŸ", anim: "anim-shake" },

            // ğŸ¦¶ è…¿éƒ¨/è„šéƒ¨
            { t: "æ­¥æ­¥é«˜å‡", d: "åŸåœ°è¸æ­¥ï¼Œè†ç›–æŠ¬é«˜ï¼", icon: "ğŸƒ", anim: "anim-bounce" },
            { t: "å‹¾è„šæ•°é’±", d: "è„šå°–ç”¨åŠ›å‘å›å‹¾ï¼Œæ‹‰ä¼¸å°è…¿", icon: "ğŸ©°", anim: "anim-stretch" },
            { t: "è¸®è„šæœ›è¿œ", d: "è„šè·ŸæŠ¬èµ·ï¼Œè„šå°–ç€åœ°ï¼Œçœ‹çœ‹è¿œå¤„çš„é’±", icon: "ğŸ•´ï¸", anim: "anim-stretch" },
            { t: "è„šè¸ç”»åœˆ", d: "è½¬åŠ¨è„šè¸ï¼Œé¡ºæ—¶é’ˆä¸‰åœˆï¼Œé€†æ—¶é’ˆä¸‰åœˆ", icon: "ğŸ¦¶", anim: "anim-spin" },
            { t: "è„šè¶¾æŠ“åœ°", d: "åƒç”¨è„šè¶¾æŠ“åœ°ä¸Šçš„ç¡¬å¸ä¸€æ ·ç”¨åŠ›", icon: "ğŸ¦…", anim: "anim-breathe" },
            { t: "éšå½¢è·‘æ­¥", d: "åœ¨æ¡Œå­åº•ä¸‹å¿«é€Ÿäº¤æ›¿è·ºè„š", icon: "ğŸ¾", anim: "anim-shake" },
            { t: "å°è…¿æŒ‰æ‘©", d: "ç”¨è„šè·Ÿå»è¹­å¦ä¸€æ¡è…¿çš„å°è…¿è‚š", icon: "ğŸ¦µ", anim: "anim-shake" },

            // ğŸ‘€ çœ¼ç›/é¢éƒ¨
            { t: "è‚¡å¸‚å¤§ç›˜", d: "çœ¼çƒä¸Šä¸‹çœ‹ï¼Œæ¨¡æ‹Ÿçœ‹Kçº¿å›¾èµ°åŠ¿", icon: "ğŸ‘€", anim: "anim-bounce" },
            { t: "å¯»æ‰¾å•†æœº", d: "é¡ºæ—¶é’ˆè½¬åŠ¨çœ¼çƒä¸¤åœˆï¼Œä¸æ”¾è¿‡ä»»ä½•æœºä¼š", icon: "ğŸ§", anim: "anim-spin" },
            { t: "ç¡®è®¤çœ¼ç¥", d: "ç”¨åŠ›é—­çœ¼3ç§’ï¼Œå†ç”¨åŠ›çå¼€", icon: "ğŸ˜Œ", anim: "anim-breathe" },
            { t: "è¿œçœºæœªæ¥", d: "çœ‹å‘çª—å¤–æœ€è¿œçš„åœ°æ–¹ï¼Œæ”¾æ¾ç«çŠ¶è‚Œ", icon: "ğŸ”­", anim: "anim-stretch" },
            { t: "ç‹®å­å¼€å£", d: "å¼ å¤§å˜´å·´ä¼¸å‡ºèˆŒå¤´ï¼Œæ”¾æ¾é¢éƒ¨è‚Œè‚‰", icon: "ğŸ¦", anim: "anim-stretch" },
            { t: "é¼“è…®çº³ç¦", d: "åƒæ²³è±šä¸€æ ·é¼“èµ·è…®å¸®å­ï¼Œæ†‹æ°”5ç§’", icon: "ğŸ¡", anim: "anim-breathe" },
            { t: "çœ‰å¼€çœ¼ç¬‘", d: "æŒ‘åŠ¨çœ‰æ¯›ï¼Œæ´»åŠ¨é¢å¤´", icon: "ğŸ¤¨", anim: "anim-shake" }
        ];
        
        const urgentTexts = [
            "æ•‘æ•‘ï¼æ•‘æ•‘è„–å­ï¼ğŸ˜±",
            "é’±è¦é£èµ°å•¦ï¼ğŸ’¸",
            "åˆ«åšç¡¬é‚¦é‚¦çš„çŸ³å¤´ï¼ğŸ—¿",
            "èº«ä½“æœ¬é’±è¦æ²¡å•¦ï¼ğŸ“‰",
            "å¿«åŠ¨åŠ¨ï¼è¦ç”Ÿé”ˆäº†ï¼ğŸ¤–",
            "ä¸ºäº†å…»è€é‡‘ï¼å†²å•Šï¼ğŸ‘µ",
            "é¢ˆæ¤åœ¨å°–å«å•Šï¼ğŸ“¢",
            "ä¸æƒ³å˜æˆé©¼èƒŒè±¹ï¼ğŸ†",
            "åŠ¨èµ·æ¥ï¼é’±åœ¨ç­‰ä½ ï¼ğŸ’°",
            "å¥åº·å€¼ -1 -1 -1 ğŸ“‰"
        ];

        const state = {
            isWorking: true, isExercising: false, isPaused: false, money: 0,
            countdownTimer: null, workTimer: null, wanderTimer: null,
            timeRemaining: CONFIG.WORK_TIME_SECONDS
        };

        const elements = {
            wrapper: document.getElementById('main-wrapper'),
            leopard: document.getElementById('leopard'),
            bubble: document.getElementById('banner'),
            finishBtn: document.getElementById('finish-btn'),
            actionTitle: document.getElementById('action-title'),
            actionDesc: document.getElementById('action-desc'),
            countdownDisplay: document.getElementById('countdown-display'),
            moneyCount: document.getElementById('money-count'),
            workTimerDisplay: document.getElementById('work-timer'),
            btnResetPos: document.getElementById('btn-reset-pos'),
            btnPause: document.getElementById('btn-pause'),
            btnRestart: document.getElementById('btn-restart')
        };

        // === é€»è¾‘æ ¸å¿ƒ ===
        function init() {
            updateTimerUI(state.timeRemaining);
            startWorkLoop();
            startWandering(); 
        }

        function startWorkLoop() {
            state.isWorking = true;
            resetVisuals();
            if(state.workTimer) clearInterval(state.workTimer);
            state.workTimer = setInterval(() => {
                if (state.isPaused) return;
                state.timeRemaining--;
                updateTimerUI(state.timeRemaining);
                if (state.timeRemaining <= 0) {
                    clearInterval(state.workTimer);
                    startExercise();
                }
            }, 1000);
        }

        function updateTimerUI(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            elements.workTimerDisplay.innerText = `${m}:${s}`;
        }

        function startExercise() {
            state.isWorking = false;
            state.isExercising = true;
            stopWandering();

            const action = exerciseLibrary[Math.floor(Math.random() * exerciseLibrary.length)];
            elements.actionTitle.innerText = action.t;
            elements.actionDesc.innerText = action.d;
            elements.leopard.innerText = action.icon;
            elements.leopard.className = "leopard-visual"; 
            void elements.leopard.offsetWidth; 
            elements.leopard.classList.add(action.anim);

            elements.bubble.style.display = 'block';
            elements.actionDesc.style.display = 'block';
            elements.finishBtn.style.display = 'none';
            elements.countdownDisplay.style.display = 'none';

            setTimeout(() => { startCountdownSequence(); }, (CONFIG.EXERCISE_TOTAL_SECONDS - CONFIG.URGENT_SECONDS) * 1000);
        }

        function startCountdownSequence() {
            if (!state.isExercising) return;
            const randomText = urgentTexts[Math.floor(Math.random() * urgentTexts.length)];
            elements.wrapper.classList.add('urgent-mode');
            elements.actionTitle.innerText = randomText;
            elements.actionDesc.style.display = 'none'; 
            elements.finishBtn.style.display = 'block'; 
            elements.countdownDisplay.style.display = 'block';
            
            let secondsLeft = CONFIG.URGENT_SECONDS;
            elements.countdownDisplay.innerText = secondsLeft;
            
            if(state.countdownTimer) clearInterval(state.countdownTimer);
            state.countdownTimer = setInterval(() => {
                if (state.isPaused) return;
                secondsLeft--;
                elements.countdownDisplay.innerText = secondsLeft;
                if (secondsLeft <= 0) handleTimeout();
            }, 1000);
        }

        function handleTimeout() {
            clearInterval(state.countdownTimer);
            elements.leopard.innerText = "ğŸ’¸"; 
            elements.leopard.className = "leopard-visual anim-fly-away";
            elements.actionTitle.innerText = "é£èµ°äº†...";
            elements.finishBtn.style.display = 'none';
            elements.countdownDisplay.style.display = 'none';
            showEffect("æœ¬é’± -1");
            
            setTimeout(() => { 
                state.isExercising = false; 
                state.timeRemaining = CONFIG.WORK_TIME_SECONDS;
                startWorkLoop();
                startWandering(); 
            }, 1600);
        }

        elements.finishBtn.addEventListener('click', (e) => {
            // æ³¨æ„ï¼šå› ä¸ºæœ‰ -webkit-app-region: dragï¼Œæ‰€ä»¥æŒ‰é’®å¿…é¡»åœ¨ CSS é‡Œè®¾ä¸º no-drag æ‰èƒ½ç‚¹å‡»
            e.stopPropagation(); 
            if (state.countdownTimer) clearInterval(state.countdownTimer);
            completeAndReward();
        });

        function completeAndReward() {
            state.isExercising = false;
            elements.leopard.innerText = "ğŸ¤‘"; 
            elements.leopard.className = "leopard-visual"; 
            elements.leopard.style.animation = "idle-bounce 0.4s infinite"; 
            addMoney(10);
            
            setTimeout(() => { 
                state.timeRemaining = CONFIG.WORK_TIME_SECONDS;
                startWorkLoop(); 
                startWandering(); 
            }, 1500);
        }

        function resetVisuals() {
            elements.wrapper.classList.remove('urgent-mode');
            elements.bubble.style.display = 'none';
            elements.leopard.innerText = "ğŸ†";
            elements.leopard.className = "leopard-visual"; 
            elements.leopard.style.animation = "idle-bounce 2s infinite ease-in-out"; 
        }

        function addMoney(amount) {
            state.money += amount;
            elements.moneyCount.innerText = state.money;
            showEffect("+ğŸ’°");
        }

        function showEffect(text) {
            const effect = document.createElement('div');
            effect.className = 'effect-text';
            effect.innerText = text;
            elements.wrapper.appendChild(effect);
            setTimeout(() => effect.remove(), 1500);
        }

        // === ğŸš¶ æ•£æ­¥é€»è¾‘ (é€šè¿‡ IPC æ§åˆ¶çª—å£ç§»åŠ¨) ===
        function startWandering() {
            if (state.wanderTimer) clearInterval(state.wanderTimer);
            state.wanderTimer = setInterval(() => {
                if (state.isWorking && !state.isPaused) {
                    // 50% æ¦‚ç‡èµ°åŠ¨
                    if (Math.random() > 0.5) performWalk();
                }
            }, 4000); 
        }
        
        function stopWandering() {
            if (state.wanderTimer) clearInterval(state.wanderTimer);
        }

        function performWalk() {
            // éšæœºç§»åŠ¨é‡ (å°ç¢æ­¥)
            const moveX = Math.floor((Math.random() - 0.5) * 60); 
            const moveY = Math.floor((Math.random() - 0.5) * 20); 

            // è½¬èº«
            if (moveX < 0) elements.leopard.classList.add('facing-left');
            else elements.leopard.classList.remove('facing-left');

            // å‘é€ç»™ Main Process è®©çª—å£åŠ¨èµ·æ¥
            ipcRenderer.send('window-move', { x: moveX, y: moveY });
        }

        // === æŒ‰é’®åŠŸèƒ½ ===
        elements.btnResetPos.addEventListener('click', () => {
            // å‘é€é‡ç½®è¯·æ±‚
            ipcRenderer.send('window-reset');
        });

        elements.btnPause.addEventListener('click', () => {
            state.isPaused = !state.isPaused;
            elements.btnPause.innerText = state.isPaused ? "â–¶" : "âšâš";
        });

        elements.btnRestart.addEventListener('click', () => {
            if(state.workTimer) clearInterval(state.workTimer);
            if(state.countdownTimer) clearInterval(state.countdownTimer);
            state.isPaused = false;
            elements.btnPause.innerText = "âšâš";
            state.timeRemaining = CONFIG.WORK_TIME_SECONDS;
            state.isExercising = false;
            resetVisuals();
            startWorkLoop();
            startWandering();
        });

        init();
    </script>
</body>
</html>